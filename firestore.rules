rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---

    // Mengambil role dari dokumen user
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    // Cek apakah user memiliki role tertentu
    function isRole(roleName) {
      return request.auth != null && getUserRole() == roleName;
    }

    // Grup: Admin Inti (Super Admin, Ketua, Wakil Ketua)
    // PERHATIKAN: Wakil Ketua ada di sini
    function isCoreAdmin() {
      return request.auth != null && getUserRole() in ['super_admin', 'ketua', 'wakil_ketua'];
    }

    // Grup: Seluruh Pengurus (BPH + Koordinator)
    function isPengurus() {
      return request.auth != null && getUserRole() in [
        'super_admin', 'ketua', 'wakil_ketua', 
        'sekretaris', 'bendahara', 'koordinator'
      ];
    }

    // ==========================================================
    // 1. USERS COLLECTION
    // ==========================================================
    match /users/{uid} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && uid == request.auth.uid;
      allow update: if request.auth != null && (uid == request.auth.uid || isCoreAdmin());
      allow delete: if isRole('super_admin');
    }

    // ==========================================================
    // 2. FINANCIAL RECORDS (Bendahara & Wakil Ketua/Ketua untuk ACC)
    // ==========================================================
    match /financial_records/{id} {
      allow read: if request.auth != null; 
      allow create: if isRole('bendahara') || isCoreAdmin();
      
      // PERBAIKAN DI SINI:
      // Menambahkan 'isCoreAdmin()' agar Wakil Ketua bisa update (ACC) status
      allow update: if isRole('bendahara') || isCoreAdmin();
      
      // Delete tetap hanya Super Admin atau Bendahara (agar data aman)
      allow delete: if isRole('bendahara') || isRole('super_admin');
    }

    // ==========================================================
    // 3. ACTIVITIES / KEGIATAN (Sekretaris, Koord & Wakil Ketua ACC)
    // ==========================================================
    match /activities/{id} {
      allow read: if true;
      allow create: if isPengurus();
      
      // PERBAIKAN: Pastikan Core Admin (Wakil) bisa update/ACC
      // isPengurus() sebenarnya sudah mencakup Wakil, tapi ini aman.
      allow update: if isPengurus(); 
      allow delete: if isPengurus();
    }

    // ==========================================================
    // 4. ARISAN HISTORY (Koordinator)
    // ==========================================================
    match /arisan_history/{id} {
      allow read: if request.auth != null;
      allow create, update, delete: if isRole('koordinator') || isCoreAdmin();
    }

    // ==========================================================
    // 5. INVENTORY / BARANG (Koordinator)
    // ==========================================================
    match /inventory/{id} {
      allow read: if request.auth != null;
      allow create, update, delete: if isRole('koordinator') || isCoreAdmin();
    }

    // ==========================================================
    // 6. NOTIFICATIONS / PENGUMUMAN
    // ==========================================================
    match /notifications/{id} {
      allow read: if true;
      allow create, delete: if isPengurus();
    }

    // ==========================================================
    // 7. POLLS / VOTING
    // ==========================================================
    match /polls/{id} {
      allow read: if request.auth != null;
      allow create: if isRole('koordinator') || isCoreAdmin();
      allow update: if request.auth != null; // User vote
      allow delete: if isRole('koordinator') || isCoreAdmin();
    }

    // ==========================================================
    // 8. ARCHIVES, LETTERS, MINUTES (Sekretaris)
    // ==========================================================
    match /archives/{id} {
      allow read: if request.auth != null;
      allow write: if isRole('sekretaris') || isCoreAdmin();
    }
    match /letters/{id} {
      allow read: if request.auth != null;
      allow write: if isRole('sekretaris') || isCoreAdmin();
    }
    match /minutes/{id} {
      allow read: if request.auth != null;
      allow write: if isRole('sekretaris') || isCoreAdmin();
    }
    
    // ==========================================================
    // 9. TITIK KUMPUL / GATHERING HISTORY
    // ==========================================================
    match /gathering_history/{id} {
      allow read: if request.auth != null;
      allow write: if isRole('bendahara') || isCoreAdmin();
    }

    // ==========================================================
    // 10. EVENTS (dari aplikasi existing - Kegiatan)
    // ==========================================================
    match /events/{id} {
      allow read: if true; // Public read untuk upcoming events
      allow create: if isPengurus();
      allow update: if isPengurus();
      allow delete: if isCoreAdmin();
    }

    // ==========================================================
    // 11. VOTINGS (dari aplikasi existing - Musyawarah)
    // ==========================================================
    match /votings/{id} {
      allow read: if request.auth != null;
      allow create: if isCoreAdmin(); // Hanya admin inti buat voting
      allow update: if request.auth != null; // Anggota bisa vote
      allow delete: if isCoreAdmin();
    }

    // ==========================================================
    // 12. FINANCES (dari aplikasi existing - Transparansi Keuangan)
    // ==========================================================
    match /finances/{id} {
      allow read: if request.auth != null; // Semua anggota bisa lihat
      allow create: if isRole('bendahara') || isCoreAdmin();
      allow update: if isRole('bendahara') || isCoreAdmin();
      allow delete: if isRole('super_admin'); // Hanya super admin hapus
    }

    // ==========================================================
    // 13. ANNOUNCEMENTS (Pengumuman Dashboard)
    // ==========================================================
    match /announcements/{id} {
      allow read: if true; // Public read
      allow create, update, delete: if isPengurus();
    }
  }
}
